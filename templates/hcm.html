{% extends "base.html" %}
{% block head %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.21/datatables.min.css" />
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.21/datatables.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />

<script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
<script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
<script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
<script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
<script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-data.js" charset="utf-8"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>
   <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
 integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
 crossorigin=""></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

<!-- <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" /> -->


<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/1.1.1/chartjs-plugin-zoom.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
  // Chart.register(zoomPlugin);
</script>
<script src="BeCaked{{ url_for('static', filename='js/draw_maps.js') }}"></script>
<script src="BeCaked{{ url_for('static', filename='js/draw.js') }}"></script>
{% endblock %}
{% block content %}

<div class="dropdown mr-1" style="position: fixed; top: calc(60px + 1em); right: 0; z-index: 99999;">
  <button type="button" class="btn btn-secondary dropdown-toggle" id="district" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-offset="10,20">
    {{ name }}
  </button>
  <div class="dropdown-menu" aria-labelledby="district">
    {% for district in districts %}
    <div class="dropdown-item btn" onclick="load_district('{{ district }}')">{{district}}</div>
    {% endfor %}
  </div>
</div>

<div class="container-fluid hcm-homepage">
  <div class="row" style="margin-top: 1em; margin-bottom: 1em;">
    <div class="col-lg-8 col-sm-12" align="left">
      <!-- left -->
      <div class="container-fluid" style="border-radius: 20px; height: calc(100vh - 60px - 2em);" id="mapContainer"></div>
    </div>
    <div class="col-lg-4 col-sm-12" align="left">
      <!-- right -->
      <div class="container-fluid" style="margin-top: 1em; margin-bottom: 1em; height: auto; min-height: 100%">
        <div class="text-center" style="padding-bottom: .25em; font-size: 2em;">
          {{ today[:-6].upper() }}
        </div>
        <div class="row scalable">
          <div class="col-lg-6 col-sm-12 text-center">
            <div class="txt-1">CA MỚI</div>
            <div class="txt-2">(PCR + TEST)</div>
            <div class="num-1">977 + 649</div>
          </div>
          <div class="col-lg-6 col-sm-12 text-center">
            <div class="txt-1">TỔNG SỐ CA</div>
            <div class="txt-2">(ĐỢT 4)</div>
            <div class="num-1">425,336</div>
          </div>
          <div class="col-lg-6 col-sm-12 text-center">
            <div class="txt-1">XUẤT VIỆN</div>
            <div class="num-1">250,267</div>
            <div class="num-2">+718</div>
          </div>
          <div class="col-lg-6 col-sm-12 text-center">
            <div class="txt-1">HỒI PHỤC KCL</div>
            <div class="num-1">110,870</div>
            <div class="num-2">+585</div>
          </div>
          <div class="col-lg-6 col-sm-12 text-center">
            <div class="txt-1">ĐIỀU TRỊ</div>
            <div class="num-1">11,305</div>
            <div class="num-2">+1,212</div>
          </div>
          <div class="col-lg-6 col-sm-12 text-center">
            <div class="txt-1">TỬ VONG</div>
            <div class="num-1">16,618</div>
            <div class="num-2">+32</div>
          </div>
          <div class="col-lg-6 col-sm-12 text-center">
            <div class="txt-1">MŨI 1</div>
            <div class="num-1">7,249,076</div>
            <div class="num-2">+85,887</div>
          </div>
          <div class="col-lg-6 col-sm-12 text-center">
            <div class="txt-1">MŨI 2</div>
            <div class="num-1">5,689,910</div>
            <div class="num-2">+17,796</div>
          </div>
          <div class="col-lg-6 col-sm-12 text-center">
            <div class="txt-1">F0 TẠI NHÀ</div>
            <div class="num-1">21,025</div>
          </div>
          <div class="col-lg-6 col-sm-12 text-center">
            <div class="txt-1">F0 KCL</div>
            <div class="num-1">5,313</div>    
          </div>
          <div class="col-lg-6 col-sm-12 text-center">
            <div class="txt-1">THỞ MÁY XÂM LẤN</div>
            <div class="num-1">255</div>    
          </div>
          <div class="col-lg-6 col-sm-12 text-center">
            <div class="txt-1">ECMO</div>
            <div class="num-1">12</div>    
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-8 col-md-12" align="left">
      <!-- left -->
      <div id="days" value="-1"></div>
      <div id = "scenario"></div>
      <div class="btn-group d-flex" role="group" style="padding-bottom: 1em;">
        <button type="button" class="btn btn-sm btn-dark w-100 active g-time" onclick="check(this,'g-time'); $('#days').attr('value','-1'); load_chart()">
          <span class="hide-sm">Tất cả</span>
          <span class="visible-sm"><i class="fas fa-infinity"></i></span>
        </button>
        <button type="button" class="btn btn-sm btn-dark w-100 g-time" onclick="check(this,'g-time'); $('#days').attr('value','28'); load_chart()">
          <span class="hide-sm">28 ngày</span>
          <span class="visible-sm">28</i></span>
        </button>
        <button type="button" class="btn btn-sm btn-dark w-100 g-time" onclick="check(this,'g-time'); $('#days').attr('value','7'); load_chart()">
          <span class="hide-sm">7 ngày</span>
          <span class="visible-sm">7</i></span>
        </button>
        <button type="button" class="btn btn-sm btn-dark w-100 g-scenario" onclick="$('#scenario').attr('value','best'); load_chart(); check(this,'g-scenario')">
          <span class="hide-sm">Kịch bản tốt</span>
          <span class="visible-sm"><i class="fas fa-check-double"></i></span>
        </button>
        <button type="button" class="btn btn-sm btn-dark w-100 active g-scenario" onclick="$('#scenario').attr('value','normal'); load_chart(); check(this,'g-scenario')">
          <span class="hide-sm">Kịch bản bình thường</span>
          <span class="visible-sm"><i class="fas fa-check"></i></span>
        </button>
        <button type="button" class="btn btn-sm btn-dark w-100 g-scenario" onclick="$('#scenario').attr('value','worst'); load_chart(); check(this,'g-scenario')">
          <span class="hide-sm">Kịch bản xấu</span>
          <span class="visible-sm"><i class="fas fa-exclamation-triangle"></i></span>
        </button>
        <button type="button" class="btn btn-sm btn-dark w-30 g-scenario" onclick = "resetZoom(my_chart_i); resetZoom(my_chart_r); resetZoom(my_chart_d); resetZoom(my_chart_c)">
          <i class="fas fa-expand-alt"></i>
        </button>
      </div>
  
      <div id="carousel-example-generic-captions" class="carousel slide" data-ride="carousel">
			  		<!-- Indicators -->
					  <ol class="carousel-indicators">
						<li data-target="#carousel-example-generic-captions" data-slide-to="0" class="active"></li>
						<li data-target="#carousel-example-generic-captions" data-slide-to="1"></li>
						<li data-target="#carousel-example-generic-captions" data-slide-to="2"></li>
            <li class="only-hcm" data-target="#carousel-example-generic-captions" data-slide-to="3"></li>
					  </ol>                      
				  <!-- Wrapper for slides -->
				  <div class="carousel-inner" role="listbox">
					<div class="carousel-item active forcast-charts">
            <h5 style="color:#19191a">DỰ BÁO SỐ CA NHIỄM MỚI HÀNG NGÀY</h5>
            <div></div>
					  <canvas id="chart_i"></canvas>
					</div>
					<div class="carousel-item forcast-charts">
            <h5 style="color:#19191a">DỰ BÁO SỐ CA HỒI PHỤC HÀNG NGÀY</h5>
					  <canvas id="chart_r"></canvas>
					</div>
					<div class="carousel-item forcast-charts">
            <h5 style="color:#19191a">DỰ BÁO SỐ CA TỬ VONG HÀNG NGÀY</h5>
					  <canvas id="chart_d"></canvas>
					</div>
          <div class="carousel-item forcast-charts only-hcm">
            <h5 style="color:#19191a">DỰ BÁO SỐ BỆNH NHÂN Ở TẦNG 3</h5>
					  <canvas id="chart_c"></canvas>
					</div>
				  </div>
				  <!-- Controls -->
				  <a class="carousel-control-prev" href="#carousel-example-generic-captions" role="button" data-slide="prev">
					<span class="carousel-control-prev-icon" aria-hidden="true"></span>
					<span class="sr-only">Previous</span>
				  </a>
				  <a class="carousel-control-next" href="#carousel-example-generic-captions" role="button" data-slide="next">
					<span class="carousel-control-next-icon" aria-hidden="true"></span>
					<span class="sr-only">Next</span>
				  </a>
				</div> 
    </div>
    <div class="col-lg-4 col-md-12" align="left">
      <!-- right -->
      <div class="text-center" style="padding-bottom: .25em; font-size: 2em;">
        BỆNH VIỆN
      </div>
      <table class="table table-hover table-responsive text-center" style="height: calc(100vh - 116px - 1em -  6em); overflow-y: scroll;">
        <tr style="position: sticky; top: 0; z-index: 1; background-color: #7f8c8d;">
          <th>Phân loại</th>
          <th>Trong ngày</th>
          <th>Ngày trước</th>
        </tr>
        <tr>
          <td>Tầng 2</td>
          <td>9,522</td>
          <td>+313</td>
        </tr>
        <tr>
          <td>Tầng 3</td>
          <td>1,783</td>
          <td>+4</td>
        </tr>
        <tr style="background-color: yellow;">
          <td>Tổng T.2 + T.3</td>
          <td>11,305</td>
          <td>+317</td>
        </tr>
        <tr>
          <th>Thở nội khí quản</th>
          <th>255</th>
          <th>-2</th>
        </tr>
        <tr>
          <td>trong đó ECMO</td>
          <td>12</td>
          <td>+1</td>
        </tr>
        <tr>
          <td>Thở máy không xâm lấn</td>
          <td>238</td>
          <td>-4</td>
        </tr>
        <tr>
          <td>Thở oxy qua mũi, mask</td>
          <td>1,408</td>
          <td>+27</td>
        </tr>
        <tr style="background-color: yellow;">
          <td>Tổng hỗ trợ hô hấp</td>
          <td>1,901</td>
          <td>+21</td>
        </tr>
        <tr>
          <th>Xuất viện - Trẻ em</th>
          <th>77</th>
          <th>0</th>
        </tr>
        <tr>
          <td>Xuất viện - Phụ nữ mang thai</td>
          <td>5</td>
          <td>0</td>
        </tr>
        <tr>
          <td>Xuất viện - Khác</td>
          <td>636</td>
          <td>-151</td>
        </tr>
        <tr style="background-color: yellow;">
          <td>Tổng xuất viện</td>
          <td>718</td>
          <td>-151</td>
        </tr>
        <tr>
          <th>Tử vong - Trẻ em</th>
          <th>0</th>
          <th>0</th>
        </tr>
        <tr>
          <td>Tử vong - Phụ nữ mang thai</td>
          <td>0</td>
          <td>0</td>
        </tr>
        <tr>
          <td>Tử vong - Khác</td>
          <td>32</td>
          <td>0</td>
        </tr>
        <tr style="background-color: yellow;">
          <td>Tổng tử vong</td>
          <td>32</td>
          <td>0</td>
        </tr>
      </table>
    </div>
  </div>
</div>
</div>

<script>
  // map scripts
  basemap = L.tileLayer('https://pcd.hcmgis.vn/geoserver/gwc/service/wmts?service=wmts&request=GetTile&version=1.0.0&layer=hcm_map:hcm_map_all&tilematrixset=EPSG:900913&tilematrix=EPSG:900913:{z}&tilerow={y}&tilecol={x}&format=image%2Fpng', {
    attribution: "<a href='https://hcmgis.vn/' target='_blank'>HCMGIS</a>", maxZoom: 20, fillOpacity: 1
  });

  var map = new L.Map(
    document.getElementById('mapContainer'),
    {
      center: { lat: 10.762622, lng: 106.660172 },
      zoom: 10.2,
      layers: [basemap]
    }
  );
  
  var prevLayerClicked = null;
  var mystyle = function(level){ 
    color = level == 1  ? { default: '#27ae60', click: '#2ecc71'}:
            level == 2  ? { default: '#f39c12', click: '#feca57'}:
            level == 3  ? { default: '#e74c3c', click: '#ff6b6b'}:
                          '#7f8c8d';
    return {
      default: {
        "color": color.default,
        "opacity": .3,
        "fillOpacity": .35
      },
      click: {
        "color": color.click,
        "weight": 5,
        "opacity": .3,
        "fillOpacity": .5
      }}
  }

  levels = {{ levels|tojson }}
 
  var quanhuyen = new L.GeoJSON.AJAX("BeCaked{{ url_for('static', filename='data/quanhuyen_2021.geojson') }}",{
                      style: function(district) {
                          id_2 = district.properties["maDVHC"]
                          level = levels[id_2]
                          return  mystyle(level).default
                        },
                        onEachFeature: function (district, layer) {
                              layer.on({
                                mouseover: function(e){
                                  id_2 = district.properties["maDVHC"]
                                  level = levels[id_2]
                                  name_2= district.properties["diaDanh"]

                                  text = '<div style="font-weight: bold">'+name_2
                                  text += '<div> Cấp độ dịch: '+level+'</div>'
                                  text += '<div> Diện tích: '+parseInt(district.properties["dienTich"])+'km<sup>2</sup></div>'
                                  text += '<div> Dân số: '+district.properties["danSoThuTe"].toLocaleString()+'</div>'
                                  layer.bindPopup(text).openPopup();
                                },

                                click: function(e){
                                  var id_2 = e.target.feature.properties["maDVHC"]
                                  var level = levels[id_2]

                                  if (prevLayerClicked !== null) {
                                      // Reset style
                                    prevLayerClicked.setStyle(mystyle(prevLevel).default);
                                  }
                                  map.fitBounds(e.target.getBounds());
                                  var layer = e.target;
                                  layer.setStyle(mystyle(level).click);
                                  if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                                    layer.bringToFront();
                                  }
                                  // info.update(layer.feature.properties.availability);
                                  prevLayerClicked = layer;
                                  prevLevel = level;

                                }
                                });
                          }
                    });

  var phuongxa = new L.GeoJSON.AJAX("BeCaked{{ url_for('static', filename='data/phuongxa_2021.geojson') }}",{
                      style: function(phuong) {
                                id_3 = phuong.properties["maDVHCXa"]
                                level = levels[id_3]
                                return  mystyle(level).default
                              },
                              onEachFeature: function (phuong, layer) {
                                    layer.on({
                                      mouseover: function(e){
                                        id_3 = phuong.properties["maDVHCXa"]
                                        id_2 = phuong.properties["maDVHCHuye"]
                                        name_3 = phuong.properties["diaDanhXa"]
                                        name_2 = phuong.properties["diaDanhHuy"]

                                        text = '<div style="font-weight: bold">'+name_3 + ' - ' + name_2+'</div>'
                                        text += '<div> Cấp độ dịch của Phường/Xã: '+levels[id_3]+'</div>'
                                        text += '<div> Cấp độ dịch của Quận/Huyện: '+levels[id_2]+'</div>'
                                        text += '<div> Diện tích: '+parseInt(phuong.properties["dienTich"])+'km<sup>2</sup></div>'
                                        text += '<div> Dân số: '+phuong.properties["danSoThucT"].toLocaleString()+'</div>'
                                        layer.bindPopup(text).openPopup();
                                      },

                                      click: function(e){
                                        var id_3 = e.target.feature.properties["maDVHCXa"]
                                        var level = levels[id_3]

                                        if (prevLayerClicked !== null) {
                                            // Reset style
                                          prevLayerClicked.setStyle(mystyle(prevLevel).default);
                                        }
                                        map.fitBounds(e.target.getBounds());
                                        var layer = e.target;
                                        layer.setStyle(mystyle(level).click);
                                        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                                          layer.bringToFront();
                                        }
                                        // info.update(layer.feature.properties.availability);
                                        prevLayerClicked = layer;
                                        prevLevel = level;

                                      }
                                    });
                                }
                    });
 
  quanhuyen.addTo(map)
  map.on('zoomend', function() {
          var zoomlevel = map.getZoom();
              if (zoomlevel < 12){
                  if (map.hasLayer(phuongxa)) {
                      map.removeLayer(phuongxa);
                  } 
                  if (!map.hasLayer(quanhuyen)){
                      map.addLayer(quanhuyen)
                  }
              }
              if (zoomlevel >= 12){
                if (map.hasLayer(quanhuyen)) {
                      map.removeLayer(quanhuyen);
                  } 
                if (!map.hasLayer(phuongxa)){
                      map.addLayer(phuongxa)
                  }
              }
          });
</script>

<script type = "text/javascript">
// chart scripts
  _district = 'hcm';

  function resetZoom(x)
  {
    x.resetZoom();
  }
  function load_chart(){
    days = $("#days")[0].getAttribute('value');
    load_chart_i();
    load_chart_r();
    load_chart_d();
    load_chart_c();
  }
  function load_chart_i()
  {
    scenario = ($("#scenario").attr("value") == undefined) ? "best" : $("#scenario").attr("value");
    my_chart_i.destroy();
    $.getJSON('/BeCaked/__load_data?district='+_district+'&&state=I&&scenario='+scenario, function(data) {
      my_chart_i = draw_chart('chart_i', data,days)
     });
  }
  function load_chart_r()
  {
    scenario = ($("#scenario").attr("value") == undefined) ? "best" : $("#scenario").attr("value");
    my_chart_r.destroy();
    $.getJSON('/BeCaked/__load_data?district='+_district+'&&state=R&&scenario='+scenario, function(data) {
      my_chart_r = draw_chart('chart_r', data,days)
     });
  }
  function load_chart_d()
  {
    scenario = ($("#scenario").attr("value") == undefined) ? "best" : $("#scenario").attr("value");
    my_chart_d.destroy();
    $.getJSON('/BeCaked/__load_data?district='+_district+'&&state=D&&scenario='+scenario, function(data) {
      my_chart_d = draw_chart('chart_d', data,days)
     });
  }
  function load_chart_c()
  {
    my_chart_c.destroy();
    if (_district == 'hcm'){
      $(".carousel-indicators").append('<li class="only-hcm" data-target="#carousel-example-generic-captions" data-slide-to="3"></li>')
      $(".carousel-inner").append('<div class="carousel-item forcast-charts only-hcm"><h5 style="color:#19191a">DỰ BÁO SỐ BỆNH NHÂN Ở TẦNG 3</h5><canvas id="chart_c"></canvas></div>')

      scenario = ($("#scenario").attr("value") == undefined) ? "best" : $("#scenario").attr("value");
      $.getJSON('/BeCaked/__load_data?district='+_district+'&&state=C&&scenario='+scenario, function(data) {
        my_chart_c = draw_chart('chart_c', data,days)
      });
    }
    else {
      $('.carousel-indicators .active').removeClass('active')
      $('.carousel-indicators li:first-child').addClass('active')
      $('.carousel-inner .active').removeClass('active')
      $('.carousel-inner div:first-child').addClass('active')
      $('.only-hcm').remove()
    }
  }
  function load_district(x){
      _district = x.toLowerCase().replace(' ','_');
      $("#district").text(x);
      if ($('.active.only-hcm').length > 0){

      }
      load_chart();
  }

  scenario = ($("#scenario").attr("value") == undefined) ? "best" : $("#scenario").attr("value");
  $.getJSON('/BeCaked/__load_data?district='+_district+'&&state=I&&scenario='+scenario, function(data) {
      my_chart_i = draw_chart('chart_i', data,days)
  });
  $.getJSON('/BeCaked/__load_data?district='+_district+'&&state=R&&scenario='+scenario, function(data) {
      my_chart_r = draw_chart('chart_r', data,days)
  });
  $.getJSON('/BeCaked/__load_data?district='+_district+'&&state=D&&scenario='+scenario, function(data) {
      my_chart_d = draw_chart('chart_d', data,days)
  });
  $.getJSON('/BeCaked/__load_data?district='+_district+'&&state=C&&scenario='+scenario, function(data) {
      my_chart_c = draw_chart('chart_c', data,days)
  });
  </script>

<script>
  // other scripts
  function check(ele,group){
    $("."+group).removeClass("active")
    ele.classList.add("active")
  }
</script>


{% endblock %}

{% block lastupdate %}
<div style="padding-top: 1.75em; font-style: italic; font-size: 80%; color: #fff">
  Last updated {{ today }}
</div>
{% endblock %}